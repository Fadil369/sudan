name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: cloudflare-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ Build React Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build React App
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build application
        run: npm run build:production
        env:
          CI: false
          VITE_BASE_PATH: '/'
          VITE_OID_ROOT: '1.3.6.1.4.1.61026'
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'https://api.sudan.elfadil.com' }}
          VITE_APP_VERSION: '1.0.0'
          NODE_ENV: production

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: dist/
          retention-days: 1

  # â”€â”€ Deploy Frontend to Cloudflare Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-pages:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: dist/

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Pages
        id: deploy
        run: |
          set -o pipefail
          wrangler pages deploy dist \
            --project-name="${CF_PAGES_PROJECT}" \
            --branch="${DEPLOY_BRANCH}" \
            --commit-hash="${{ github.sha }}" \
            2>&1 | tee "${RUNNER_TEMP}/cf-pages-output.txt"
          URL=$(grep -oP 'https://[^\s]+\.pages\.dev' "${RUNNER_TEMP}/cf-pages-output.txt" | head -1 || true)
          echo "deployment-url=${URL}" >> "$GITHUB_OUTPUT"
        env:
          CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT || 'sudan-gov' }}
          DEPLOY_BRANCH: ${{ github.ref == 'refs/heads/main' && 'main' || github.head_ref }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Comment PR with preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.deployment-url }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                'ðŸš€ **Cloudflare Pages preview deployed!**',
                '',
                `ðŸ”— **Preview URL**: ${url}`,
                '',
                `_Commit: \`${{ github.sha }}\`_`,
              ].join('\n'),
            });

  # â”€â”€ Deploy API Worker to Cloudflare Workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-worker:
    name: Deploy API Worker
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Worker to production
        if: github.ref == 'refs/heads/main'
        run: |
          # Substitute placeholder binding IDs with real values from secrets (if provided)
          if [ -n "$KV_SESSIONS_ID" ]; then
            sed -i "s/sessions_kv_id/$KV_SESSIONS_ID/g" workers.toml
          fi
          if [ -n "$KV_CACHE_ID" ]; then
            sed -i "s/cache_kv_id/$KV_CACHE_ID/g" workers.toml
          fi
          if [ -n "$KV_OID_REGISTRY_ID" ]; then
            sed -i "s/oid_registry_kv_id/$KV_OID_REGISTRY_ID/g" workers.toml
          fi
          if [ -n "$KV_CITIZEN_PROFILES_ID" ]; then
            sed -i "s/citizen_profiles_kv_id/$KV_CITIZEN_PROFILES_ID/g" workers.toml
          fi
          if [ -n "$D1_MAIN_DB_ID" ]; then
            sed -i "s/sudan-gov-main-db-id/$D1_MAIN_DB_ID/g" workers.toml
          fi
          if [ -n "$D1_ANALYTICS_DB_ID" ]; then
            sed -i "s/sudan-gov-analytics-db-id/$D1_ANALYTICS_DB_ID/g" workers.toml
          fi
          wrangler deploy --config workers.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_SESSIONS_ID: ${{ secrets.KV_SESSIONS_ID }}
          KV_CACHE_ID: ${{ secrets.KV_CACHE_ID }}
          KV_OID_REGISTRY_ID: ${{ secrets.KV_OID_REGISTRY_ID }}
          KV_CITIZEN_PROFILES_ID: ${{ secrets.KV_CITIZEN_PROFILES_ID }}
          D1_MAIN_DB_ID: ${{ secrets.D1_MAIN_DB_ID }}
          D1_ANALYTICS_DB_ID: ${{ secrets.D1_ANALYTICS_DB_ID }}

      - name: Deploy Worker to staging (PR preview)
        if: github.event_name == 'pull_request'
        run: |
          # Substitute placeholder binding IDs with real values from secrets (if provided)
          if [ -n "$KV_SESSIONS_ID" ]; then
            sed -i "s/sessions_kv_id/$KV_SESSIONS_ID/g" workers.toml
            sed -i "s/sessions_kv_preview_id/$KV_SESSIONS_ID/g" workers.toml
          fi
          if [ -n "$KV_CACHE_ID" ]; then
            sed -i "s/cache_kv_id/$KV_CACHE_ID/g" workers.toml
            sed -i "s/cache_kv_preview_id/$KV_CACHE_ID/g" workers.toml
          fi
          if [ -n "$KV_OID_REGISTRY_ID" ]; then
            sed -i "s/oid_registry_kv_id/$KV_OID_REGISTRY_ID/g" workers.toml
            sed -i "s/oid_registry_kv_preview_id/$KV_OID_REGISTRY_ID/g" workers.toml
          fi
          if [ -n "$KV_CITIZEN_PROFILES_ID" ]; then
            sed -i "s/citizen_profiles_kv_id/$KV_CITIZEN_PROFILES_ID/g" workers.toml
            sed -i "s/citizen_profiles_kv_preview_id/$KV_CITIZEN_PROFILES_ID/g" workers.toml
          fi
          if [ -n "$D1_MAIN_DB_ID" ]; then
            sed -i "s/sudan-gov-main-db-id/$D1_MAIN_DB_ID/g" workers.toml
          fi
          if [ -n "$D1_ANALYTICS_DB_ID" ]; then
            sed -i "s/sudan-gov-analytics-db-id/$D1_ANALYTICS_DB_ID/g" workers.toml
          fi
          wrangler deploy --config workers.toml --env staging
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_SESSIONS_ID: ${{ secrets.KV_SESSIONS_ID }}
          KV_CACHE_ID: ${{ secrets.KV_CACHE_ID }}
          KV_OID_REGISTRY_ID: ${{ secrets.KV_OID_REGISTRY_ID }}
          KV_CITIZEN_PROFILES_ID: ${{ secrets.KV_CITIZEN_PROFILES_ID }}
          D1_MAIN_DB_ID: ${{ secrets.D1_MAIN_DB_ID }}
          D1_ANALYTICS_DB_ID: ${{ secrets.D1_ANALYTICS_DB_ID }}

      - name: Apply D1 Migrations (production only)
        if: github.ref == 'refs/heads/main'
        run: |
          wrangler d1 execute sudan-gov-main --file=./database/migrations/001_initial.sql --remote
          wrangler d1 execute sudan-gov-analytics --file=./database/migrations/002_analytics.sql --remote
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # â”€â”€ Post-deploy health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  health-check:
    name: Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: [deploy-pages, deploy-worker]
    if: github.ref == 'refs/heads/main'
    permissions: {}
    steps:
      - name: Check pages deployment
        run: |
          sleep 30
          curl -f https://sudan.elfadil.com/ || echo "Pages not ready yet"

      - name: Check worker API
        run: |
          curl -f https://api.sudan.elfadil.com/api/health || echo "Worker API check"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Target | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Pages | https://sudan.elfadil.com | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Worker | https://api.sudan.elfadil.com | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` | - |" >> $GITHUB_STEP_SUMMARY
