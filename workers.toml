name = "sudan-gov-api"
main = "api/index.js"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# ─── KV Namespaces ────────────────────────────────────────────────────────────
[[kv_namespaces]]
binding = "SESSIONS"
id = "1cfe518ae20e48429a21fc3512a1678d"
preview_id = "894b04654f9740bb82d7e469fe70631d"

[[kv_namespaces]]
binding = "CACHE"
id = "fa6d76cae83141028cad92d4f22a8888"
preview_id = "40ca3ed8977b459f971f5867b9d6d3a9"

[[kv_namespaces]]
binding = "OID_REGISTRY"
id = "07ea6ec79f2f46ebbc8076a2000fcfa9"
preview_id = "07ea6ec79f2f46ebbc8076a2000fcfa9"

[[kv_namespaces]]
binding = "CITIZEN_PROFILES"
id = "9778fed50d8347c28822778f50e5f908"
preview_id = "00fb520d32e14a9582e3b6dcbb6411b5"

# ─── R2 Buckets ───────────────────────────────────────────────────────────────
[[r2_buckets]]
binding = "DOCUMENTS"
bucket_name = "sudan-gov-documents"
preview_bucket_name = "sudan-gov-documents-preview"

[[r2_buckets]]
binding = "MEDIA"
bucket_name = "sudan-gov-media"
preview_bucket_name = "sudan-gov-media-preview"

[[r2_buckets]]
binding = "AUDIT_LOGS"
bucket_name = "sudan-gov-audit-logs"
preview_bucket_name = "sudan-gov-audit-logs-preview"

# ─── D1 SQL Databases ─────────────────────────────────────────────────────────
[[d1_databases]]
binding = "DB"
database_name = "sudan-gov-main"
database_id = "9db027b4-fb6b-44e3-af3f-ef4838d4077b"

[[d1_databases]]
binding = "ANALYTICS_DB"
database_name = "sudan-gov-analytics"
database_id = "f53995cb-6b96-4b33-9749-95c37cf3205b"

# ─── Durable Objects ──────────────────────────────────────────────────────────
[[durable_objects.bindings]]
name = "SESSION_DO"
class_name = "SessionDurableObject"

[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDurableObject"

[[durable_objects.bindings]]
name = "CITIZEN_STREAM"
class_name = "CitizenStreamDurableObject"

[[migrations]]
tag = "v1"
new_classes = ["SessionDurableObject", "RateLimiterDurableObject", "CitizenStreamDurableObject"]

# ─── Environment Variables (non-secret) ───────────────────────────────────────
[vars]
ENVIRONMENT = "production"
OID_ROOT = "1.3.6.1.4.1.61026"
APP_NAME = "Sudan Digital Government Portal"
CORS_ORIGIN = "https://sudan.elfadil.com"
API_VERSION = "v1"
LOG_LEVEL = "info"

# ─── Secrets (set via: wrangler secret put SECRET_NAME) ───────────────────────
# JWT_SECRET
# ENCRYPTION_KEY
# BIOMETRIC_API_KEY
# PAYMENT_GATEWAY_KEY
# SMS_API_KEY
# EMAIL_API_KEY
# BLOCKCHAIN_NODE_URL

# ─── Staging environment ──────────────────────────────────────────────────────
[env.staging]
name = "sudan-gov-api-staging"
[env.staging.vars]
ENVIRONMENT = "staging"
CORS_ORIGIN = "https://staging.sudan.elfadil.com"

# ─── Routes ───────────────────────────────────────────────────────────────────
# API Worker handles requests on the api.sudan.elfadil.com subdomain.
# CF Pages Functions at functions/api/[[path]].ts proxy sudan.elfadil.com/api/* here.
# DNS prerequisite: add an orange-cloud A/CNAME record for api.sudan.elfadil.com in Cloudflare.
routes = [{ pattern = "api.sudan.elfadil.com/*", zone_name = "elfadil.com" }]
