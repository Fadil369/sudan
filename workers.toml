name = "sudan-gov-api"
main = "api/index.js"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# ─── KV Namespaces ────────────────────────────────────────────────────────────
[[kv_namespaces]]
binding = "SESSIONS"
id = "sessions_kv_id"
preview_id = "sessions_kv_preview_id"

[[kv_namespaces]]
binding = "CACHE"
id = "cache_kv_id"
preview_id = "cache_kv_preview_id"

[[kv_namespaces]]
binding = "OID_REGISTRY"
id = "oid_registry_kv_id"
preview_id = "oid_registry_kv_preview_id"

[[kv_namespaces]]
binding = "CITIZEN_PROFILES"
id = "citizen_profiles_kv_id"
preview_id = "citizen_profiles_kv_preview_id"

# ─── R2 Buckets ───────────────────────────────────────────────────────────────
[[r2_buckets]]
binding = "DOCUMENTS"
bucket_name = "sudan-gov-documents"
preview_bucket_name = "sudan-gov-documents-preview"

[[r2_buckets]]
binding = "MEDIA"
bucket_name = "sudan-gov-media"
preview_bucket_name = "sudan-gov-media-preview"

[[r2_buckets]]
binding = "AUDIT_LOGS"
bucket_name = "sudan-gov-audit-logs"
preview_bucket_name = "sudan-gov-audit-logs-preview"

# ─── D1 SQL Databases ─────────────────────────────────────────────────────────
[[d1_databases]]
binding = "DB"
database_name = "sudan-gov-main"
database_id = "sudan-gov-main-db-id"

[[d1_databases]]
binding = "ANALYTICS_DB"
database_name = "sudan-gov-analytics"
database_id = "sudan-gov-analytics-db-id"

# ─── Durable Objects ──────────────────────────────────────────────────────────
[[durable_objects.bindings]]
name = "SESSION_DO"
class_name = "SessionDurableObject"

[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDurableObject"

[[durable_objects.bindings]]
name = "CITIZEN_STREAM"
class_name = "CitizenStreamDurableObject"

[[migrations]]
tag = "v1"
new_classes = ["SessionDurableObject", "RateLimiterDurableObject", "CitizenStreamDurableObject"]

# ─── Environment Variables (non-secret) ───────────────────────────────────────
[vars]
ENVIRONMENT = "production"
OID_ROOT = "1.3.6.1.4.1.61026"
APP_NAME = "Sudan Digital Government Portal"
CORS_ORIGIN = "https://sudan.elfadil.com"
API_VERSION = "v1"
LOG_LEVEL = "info"

# ─── Secrets (set via: wrangler secret put SECRET_NAME) ───────────────────────
# JWT_SECRET
# ENCRYPTION_KEY
# BIOMETRIC_API_KEY
# PAYMENT_GATEWAY_KEY
# SMS_API_KEY
# EMAIL_API_KEY
# BLOCKCHAIN_NODE_URL

# ─── Staging environment ──────────────────────────────────────────────────────
[env.staging]
name = "sudan-gov-api-staging"
[env.staging.vars]
ENVIRONMENT = "staging"
CORS_ORIGIN = "https://staging.sudan.elfadil.com"

# ─── Routes ───────────────────────────────────────────────────────────────────
# API Worker handles /api/* on the production domain
routes = [{ pattern = "sudan.elfadil.com/api/*", zone_name = "elfadil.com" }]
